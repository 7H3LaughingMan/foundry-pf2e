{"version":3,"file":"BatchDrawCall.mjs","sources":["../../src/core/BatchDrawCall.ts"],"sourcesContent":["import { Matrix, BaseTexture, BatchTextureArray, Shader, Texture, BLEND_MODES } from '@pixi/core';\r\n/**\r\n * @memberof PIXI.smooth\r\n */\r\nexport interface IGraphicsBatchSettings\r\n{\r\n    maxStyles: number;\r\n    maxTextures: number;\r\n    pixelLine: number;\r\n}\r\n\r\n/**\r\n * @memberof PIXI.smooth\r\n */\r\nexport function matrixEquals(th: Matrix, matrix: Matrix, eps = 1e-3)\r\n{\r\n    return this === matrix || (Math.abs(th.a - matrix.a) < eps\r\n        && Math.abs(th.b - matrix.b) < eps\r\n        && Math.abs(th.c - matrix.c) < eps\r\n        && Math.abs(th.d - matrix.d) < eps\r\n        && Math.abs(th.tx - matrix.tx) < eps\r\n        && Math.abs(th.ty - matrix.ty) < eps);\r\n}\r\n\r\n/**\r\n * @memberof PIXI.smooth\r\n */\r\nexport class BatchStyleArray\r\n{\r\n    public textureIds: number[];\r\n    public matrices: Matrix[];\r\n    public lines: number[];\r\n    public count: number;\r\n\r\n    constructor()\r\n    {\r\n        this.textureIds = [];\r\n        this.matrices = [];\r\n        this.lines = [];\r\n        this.count = 0;\r\n        // TODO: mapCoord for atlas cases\r\n        // TODO: gradients?\r\n    }\r\n\r\n    clear(): void\r\n    {\r\n        for (let i = 0; i < this.count; i++)\r\n        {\r\n            this.textureIds[i] = null;\r\n            this.matrices[i] = null;\r\n        }\r\n        this.count = 0;\r\n    }\r\n\r\n    add(textureId: number, matrix: Matrix,\r\n        lineWidth: number, lineAlignment: number, lineScaleMode: number,\r\n        settings: IGraphicsBatchSettings): number\r\n    {\r\n        const { textureIds, matrices, lines, count } = this;\r\n\r\n        textureId = (textureId * 4) + lineScaleMode;\r\n        for (let i = 0; i < count; i++)\r\n        {\r\n            if (lines[i * 2] === lineWidth && lines[(i * 2) + 1] === lineAlignment\r\n                && textureIds[i] === textureId && (matrixEquals(matrices[i], matrix)))\r\n            {\r\n                return i;\r\n            }\r\n        }\r\n        if (count >= settings.maxStyles)\r\n        {\r\n            return -1;\r\n        }\r\n        textureIds[count] = textureId;\r\n        matrices[count] = matrix;\r\n        lines[count * 2] = lineWidth;\r\n        lines[(count * 2) + 1] = lineAlignment;\r\n        this.count++;\r\n\r\n        return count;\r\n    }\r\n}\r\n\r\n/**\r\n * @memberof PIXI.smooth\r\n */\r\nexport class BatchDrawCall\r\n{\r\n    texArray: BatchTextureArray;\r\n    styleArray: BatchStyleArray;\r\n    blend: BLEND_MODES;\r\n    start: number;\r\n    size: number;\r\n    data: any;\r\n    shader: Shader;\r\n    TICK: number;\r\n    settings: IGraphicsBatchSettings;\r\n\r\n    constructor()\r\n    {\r\n        this.texArray = new BatchTextureArray();\r\n        this.styleArray = new BatchStyleArray();\r\n        this.shader = null;\r\n        this.blend = BLEND_MODES.NORMAL;\r\n\r\n        this.start = 0;\r\n        this.size = 0;\r\n        this.TICK = 0; // for filling textures\r\n        this.settings = null;\r\n        /**\r\n         * data for uniforms or custom webgl state\r\n         * @member {object}\r\n         */\r\n        this.data = null;\r\n    }\r\n\r\n    clear()\r\n    {\r\n        this.texArray.clear();\r\n        this.styleArray.clear();\r\n        this.settings = null;\r\n        this.data = null;\r\n        this.shader = null;\r\n    }\r\n\r\n    begin(settings: IGraphicsBatchSettings, shader: Shader)\r\n    {\r\n        this.TICK = ++BaseTexture._globalBatch;\r\n        this.settings = settings;\r\n        this.shader = shader;\r\n        // start and size calculated outside\r\n        this.start = 0;\r\n        this.size = 0;\r\n        this.data = null;\r\n        if (shader && (shader as any).settings)\r\n        {\r\n            this.settings = (shader as any).settings;\r\n        }\r\n    }\r\n\r\n    check(shader: Shader): boolean\r\n    {\r\n        if (this.size === 0)\r\n        {\r\n            this.shader = shader;\r\n\r\n            return true;\r\n        }\r\n\r\n        return (this.shader === shader);\r\n    }\r\n\r\n    add(texture: Texture, matrix: Matrix, lineWidth: number,\r\n        lineAlignment: number, lineScaleMode: number): number\r\n    {\r\n        const { texArray, TICK, styleArray, settings } = this;\r\n        const { baseTexture } = texture;\r\n        // check tex\r\n\r\n        if (baseTexture._batchEnabled !== TICK && texArray.count === settings.maxTextures)\r\n        {\r\n            return -1;\r\n        }\r\n        const loc = baseTexture._batchEnabled !== TICK ? texArray.count : baseTexture._batchLocation;\r\n        // check and add style\r\n        // add1 -> add2 only works in chain, not when there are several adds inside\r\n        const res = styleArray.add(loc, matrix || Matrix.IDENTITY,\r\n            lineWidth, lineAlignment, lineScaleMode, settings);\r\n\r\n        if (res >= 0)\r\n        {\r\n            // SUCCESS here\r\n            // add tex\r\n            if (baseTexture._batchEnabled !== TICK)\r\n            {\r\n                baseTexture._batchEnabled = TICK;\r\n                baseTexture._batchLocation = texArray.count;\r\n                texArray.elements[texArray.count++] = baseTexture;\r\n            }\r\n        }\r\n\r\n        return res;\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}